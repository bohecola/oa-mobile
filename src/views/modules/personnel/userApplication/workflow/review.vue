<template>
  <WorkflowPage :entity-variables="submitFormData.variables?.entity" @approval="handleApproval">
    <div v-if="isView">
      <Detail ref="DetailRef" :include-fields="includeFieldsDetail" />
    </div>

    <template v-else>
      <!-- 发起流程 第一步节点 -->
      <div v-if="taskDefinitionKey === 'Activity_020ehmy'" v-loading="loading">
        <!-- <Upsert ref="Upsert" :include-fields="includeFields" :show-loading="false" /> -->
      </div>
      <!-- 当是归档节点时需要确认系统账号和实际到岗时间 -->
      <div v-else-if="taskDefinitionKey === 'Activity_1gtf30k'" v-loading="loading">
        <Detail ref="Detail2Ref" :include-fields="includeFieldsDetail2" :show-loading="false" />
        <Detail ref="Upsert2Ref" :include-fields="includeFieldsUpsert2" :show-loading="false" />
        <Detail ref="Detail3Ref" :include-fields="includeFieldsDetail3" :show-loading="false" />
      </div>
      <!-- 其他审批通用节点 -->
      <div v-else v-loading="loading">
        <Detail ref="DetailOtherRef" :include-fields="includeFieldsOther" :show-loading="false" />
      </div>
    </template>
  </WorkflowPage>
</template>

<script setup lang="ts">
import Detail from '../detail.vue'
import type { UserEmploymentForm } from '@/api/oa/personnel/userApplication/types'
import type { StartProcessBo } from '@/api/workflow/workflowCommon/types'
import { filterTruthyKeys } from '@/utils'
import type { ApprovalPayload, Initiator } from '@/components/WorkflowPage/types'
import { useWorkflowViewData } from '@/hooks'
import type { UserPreEmploymentForm } from '@/api/oa/personnel/userPreEmployment/types'

type Entity = UserEmploymentForm & { initiator: Initiator } & UserPreEmploymentForm

// 实例
const { proxy } = getCurrentInstance() as ComponentInternalInstance

// 加载
const loading = ref(false)
// 流程节点 Key
const taskDefinitionKey = ref(proxy?.$route.query.nodeId ?? '')

// 引用
const DetailRef = ref<InstanceType<typeof Detail> | null>()
const Upsert2Ref = ref<InstanceType<typeof Detail> | null>()
const Detail2Ref = ref<InstanceType<typeof Detail> | null>()
const Detail3Ref = ref<InstanceType<typeof Detail> | null>()
const DetailOtherRef = ref<InstanceType<typeof Detail> | null>()

// 字段
const includeFields = ref(
  filterTruthyKeys<UserEmploymentForm>({
    preEmploymentId: true,
    name: true,
    nation: true,
    education: true,
    // userAccount: false,
    hopeDate: true,
    // realDate: false,
    wages: true,
    baseWages: true,
    postWages: true,
    performanceWages: true,
    probationWagesRate: true,
    description: true,
    remark: false,
    deptId: true,
    postId: true,
    deptName: true,
    postName: true,
    sex: true,
    phonenumber: true,
    isProbation: true,
    probationCycle: true,
    checked: true,
    ossIdList: true,
  }),
)

const includeFieldsDetail = ref(
  filterTruthyKeys<UserEmploymentForm>({
    preEmploymentId: true,
    nation: true,
    education: true,
    userAccount: true,
    hopeDate: true,
    realDate: true,
    wages: true,
    baseWages: true,
    postWages: true,
    performanceWages: true,
    probationWagesRate: true,
    description: true,
    remark: false,
    deptName: true,
    postName: true,
    sex: true,
    phonenumber: true,
    isProbation: true,
    probationCycle: true,
    ossIdList: true,
  }),
)

const includeFieldsOther = ref(
  filterTruthyKeys<UserEmploymentForm>({
    preEmploymentId: true,
    nation: true,
    education: true,
    userAccount: false,
    hopeDate: true,
    realDate: false,
    wages: true,
    baseWages: true,
    postWages: true,
    performanceWages: true,
    probationWagesRate: true,
    description: true,
    remark: false,
    deptName: true,
    postName: true,
    sex: true,
    phonenumber: true,
    isProbation: true,
    ossIdList: true,
  }),
)

// 归档 - 查看附件列表
const includeFieldsDetail3 = filterTruthyKeys<UserEmploymentForm>({
  ossIdList: true,
})

// 归档 - 编辑
const includeFieldsUpsert2 = filterTruthyKeys<UserEmploymentForm>({
  userAccount: true,
  realDate: true,
})

// 归档 - 查看
const includeFieldsDetail2 = filterTruthyKeys<UserEmploymentForm>({
  preEmploymentId: true,
  name: true,
  nation: true,
  education: true,
  // userAccount: true,
  hopeDate: true,
  // realDate: true,
  wages: true,
  baseWages: true,
  postWages: true,
  performanceWages: true,
  probationWagesRate: true,
  description: true,
  remark: false,
  deptName: true,
  postName: true,
  sex: true,
  phonenumber: true,
  isProbation: true,
  probationCycle: true,
  ossIdList: false,
})

// 流程表单
const submitFormData = ref<StartProcessBo<Entity>>({
  businessKey: '',
  tableName: '',
  variables: {},
})

// 是否查看
const isView = computed(() => proxy?.$route.query.type === 'view')

// 审批
async function handleApproval({ open }: ApprovalPayload) {
  // 打开审批弹窗
  // const { taskId } = proxy.$route.query;
  // let res: any;
  // if ('Activity_020ehmy' == taskDefinitionKey.value) {
  //   // 发起流程 第一步节点
  //   res = await Upsert.value?.workflowSubmit();
  // } else if ('Activity_1gtf30k' === taskDefinitionKey.value) {
  //   // 归档 节点
  //   res = await Upsert2.value?.workflowSubmit();
  // }
  // if (res) {
  //   const { valid, data } = res;
  //   if (valid) {
  //     Object.assign(submitFormData.value.variables.entity, data);
  //     open(taskId as string);
  //   }
  //   return true;
  // }
  // 打开审批弹窗
  const { taskId } = proxy?.$route.query ?? {}
  open(taskId as string)
}

// 挂载
onMounted(async () => {
  const { proxy } = (getCurrentInstance() as ComponentInternalInstance) ?? {}
  const { type, taskId, processInstanceId } = proxy?.$route.query ?? {}
  const res = await useWorkflowViewData({ taskId, processInstanceId })

  const { entity, task } = res.data
  submitFormData.value.variables.entity = entity
  taskDefinitionKey.value = task.taskDefinitionKey

  proxy?.$router.replace({
    query: {
      ...proxy?.$route.query,
      taskDefinitionKey: taskDefinitionKey.value,
      isEditNode: (taskDefinitionKey.value === 'Activity_1gtf30k') ? 'true' : 'false',
    },
  })

  nextTick(async () => {
    switch (type as string) {
      case 'update':
      case 'approval': {
        try {
          loading.value = true
          await DetailRef.value?.workflowView({ taskId, processInstanceId })

          await Detail2Ref.value?.workflowView({ taskId, processInstanceId })

          await Upsert2Ref.value?.workflowView({ taskId, processInstanceId })

          await Detail3Ref.value?.workflowView({ taskId, processInstanceId })

          await DetailOtherRef.value?.workflowView({ taskId, processInstanceId })
        }
        finally {
          loading.value = false
        }
        break
      }
      case 'view': {
        await DetailRef.value?.workflowView?.({ taskId, processInstanceId })
      }
    }
  })
})
</script>
